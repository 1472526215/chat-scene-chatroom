<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>有人 Demo</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>有人 Demo</h1>
    <p class="subtitle">输入一个词，比如「吃饭」「加班」「失眠」</p>

    <div class="search-box">
      <input
        id="topicInput"
        type="text"
        placeholder="你在做什么？例如：吃饭"
        autocomplete="off"
      />
      <button id="enterBtn">进入房间</button>
    </div>

    <div id="error" class="error"></div>
    <div class="hint">
      每个关键词对应一个房间。<br />
      例如输入「吃饭」，就会进入所有正在聊吃饭的人的群聊。
    </div>

    <!-- 新增：热门房间列表区域 -->
    <div id="roomsSection" class="rooms-section">
      <div class="rooms-title">大家正在聊：</div>
      <div id="roomList" class="room-list"></div>
    </div>
  </div>

  <script>
    const topicInput = document.getElementById('topicInput');
    const enterBtn = document.getElementById('enterBtn');
    const errorDiv = document.getElementById('error');

    const roomsSection = document.getElementById('roomsSection');
    const roomList = document.getElementById('roomList');

    // 默认先隐藏“大家正在聊”这一块
    roomsSection.style.display = 'none';

    // 抽出一个公共函数：进入某个房间
    function enterRoom(room) {
      const url = new URL(window.location.origin + '/room.html');
      url.searchParams.set('roomId', room.id);
      url.searchParams.set('roomName', room.name);
      window.location.href = url.toString();
    }

    // 原来的：根据输入的关键词进入 / 创建房间
    async function goToRoom() {
      errorDiv.textContent = '';

      const raw = topicInput.value.trim();
      if (!raw) {
        errorDiv.textContent = '请输入一个关键词，比如：吃饭';
        return;
      }

      const name = raw; // 房间名就用这个关键词

      try {
        // 1. 查询是否已有这个房间
        const res = await fetch('/api/rooms?q=' + encodeURIComponent(name));
        const rooms = await res.json();

        let room = rooms.find((r) => r.name === name);

        // 2. 没有的话就创建一个
        if (!room) {
          const createRes = await fetch('/api/rooms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name }),
          });

          if (!createRes.ok) {
            throw new Error('创建房间失败');
          }

          room = await createRes.json();
        }

        // 3. 进入房间（复用公共函数）
        enterRoom(room);
      } catch (err) {
        console.error(err);
        errorDiv.textContent = '出错了，请稍后重试。';
      }
    }

    enterBtn.addEventListener('click', goToRoom);
    topicInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        goToRoom();
      }
    });

    // 新增：加载“大家正在聊”的房间列表
    async function loadRooms() {
      try {
        const res = await fetch('/api/rooms'); // 不带 q，返回所有房间
        const rooms = await res.json();

        if (!Array.isArray(rooms) || rooms.length === 0) {
          roomsSection.style.display = 'none';
          return;
        }

        roomsSection.style.display = 'block';
        roomList.innerHTML = '';

        // 按创建时间倒序，取最新的 8 个
        const sorted = rooms
          .slice()
          .sort(
            (a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0)
          )
          .slice(0, 8);

        sorted.forEach((room) => {
          const btn = document.createElement('button');
          btn.className = 'room-item';
          btn.textContent = room.name;
          btn.onclick = () => enterRoom(room);
          roomList.appendChild(btn);
        });
      } catch (err) {
        console.error('加载房间列表失败', err);
        roomsSection.style.display = 'none';
      }
    }

    // 页面加载完就拉一次房间列表
    loadRooms();
  </script>
</body>
</html>
